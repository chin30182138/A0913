<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>職場關係分析工具</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
        .section { margin-bottom: 20px; }
        h2 { margin-bottom: 20px; }
        h3 { margin-bottom: 10px; }
        select { padding: 8px; margin: 5px; width: 100px; }
        button { padding: 10px 20px; margin-top: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .radar-chart { width: 400px; height: 400px; margin: 20px auto; }
        #result { margin-top: 20px; text-align: left; }
        .loading { display: none; text-align: center; color: #888; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        const liqinOptions = ['兄弟', '子孫', '妻財', '官鬼', '父母'];
        const liushouOptions = ['青龍', '朱雀', '勾陳', '螣蛇', '白虎', '玄武'];

        function updateOptions(person, otherPersonPrefix) {
            const liqinSelect = document.getElementById(`${person}-liqin`);
            const liushouSelect = document.getElementById(`${person}-liushou`);
            const otherLiqin = document.getElementById(`${otherPersonPrefix}-liqin`).value || '';
            const otherLiushou = document.getElementById(`${otherPersonPrefix}-liushou`).value || '';

            liqinSelect.innerHTML = '';
            liushouSelect.innerHTML = '';
            liqinOptions.forEach(option => {
                if (option !== otherLiqin) {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.text = option;
                    liqinSelect.appendChild(opt);
                }
            });
            liushouOptions.forEach(option => {
                if (option !== otherLiushou) {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.text = option;
                    liushouSelect.appendChild(opt);
                }
            });
        }

        function initializeSelects() {
            updateOptions('person1', 'person2');
            updateOptions('person2', 'person1');
        }

        async function analyzeRelationship() {
            const person1Liqin = document.getElementById('person1-liqin').value;
            const person1Liushou = document.getElementById('person1-liushou').value;
            const person1Dizhi = document.getElementById('person1-dizhi').value;
            const person2Liqin = document.getElementById('person2-liqin').value;
            const person2Liushou = document.getElementById('person2-liushou').value;
            const person2Dizhi = document.getElementById('person2-dizhi').value;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').innerText = '';
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();

            const url = 'http://localhost:3000/analyze';
            const data = {
                person1: { liqin: person1Liqin, liushou: person1Liushou, dizhi: person1Dizhi },
                person2: { liqin: person2Liqin, liushou: person2Liushou, dizhi: person2Dizhi }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP 錯誤 ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                document.getElementById('result').innerText = `分析結果：\n${result.analysis}\n- 職場關係評估:\n  - 相容性: ${result.scores.compatibility}\n  - 信任度: ${result.scores.trust}\n  - 節奏配合: ${result.scores.pace}\n  - 創新能力: ${result.scores.innovation}\n  - 溝通效率: ${result.scores.communication}`;

                window.myChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['相容性', '信任度', '節奏配合', '創新能力', '溝通效率'],
                        datasets: [{
                            label: '職場關係',
                            data: [
                                result.scores.compatibility,
                                result.scores.trust,
                                result.scores.pace,
                                result.scores.innovation,
                                result.scores.communication
                            ],
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: { scales: { r: { beginAtZero: true, max: 100 } } }
                });
            } catch (error) {
                console.error('錯誤詳情:', error); // 調試用
                document.getElementById('result').innerText = `錯誤：${error.message}\n請檢查伺服器是否運行[](http://localhost:3000)`;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', () => {
                updateOptions(select.id.startsWith('person1') ? 'person1' : 'person2', select.id.startsWith('person1') ? 'person2' : 'person1');
            });
        });

        window.onload = initializeSelects;
    </script>
</head>
<body>
    <div class="container">
        <h2>職場關係分析工具</h2>
        
        <div class="section">
            <h3>第一方信息</h3>
            <select id="person1-liqin"></select>
            <select id="person1-liushou"></select>
            <select id="person1-dizhi">
                <option value="子">子</option><option value="丑">丑</option><option value="寅">寅</option>
                <option value="卯">卯</option><option value="辰">辰</option><option value="巳">巳</option>
                <option value="午">午</option><option value="未">未</option><option value="申">申</option>
                <option value="酉">酉</option><option value="戌">戌</option><option value="亥">亥</option>
            </select>
        </div>

        <div class="section">
            <h3>第二方信息</h3>
            <select id="person2-liqin"></select>
            <select id="person2-liushou"></select>
            <select id="person2-dizhi">
                <option value="子">子</option><option value="丑">丑</option><option value="寅">寅</option>
                <option value="卯">卯</option><option value="辰">辰</option><option value="巳">巳</option>
                <option value="午">午</option><option value="未">未</option><option value="申">申</option>
                <option value="酉">酉</option><option value="戌">戌</option><option value="亥">亥</option>
            </select>
        </div>

        <button onclick="analyzeRelationship()">開始分析</button>
        <div id="loading">載入中...</div>
        <canvas id="radarChart" class="radar-chart"></canvas>
        <div id="result"></div>
    </div>
</body>
</html>
