
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>仙人指路神獸七十二型人格 一鍵分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* 基礎樣式 */
    .scores {display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 6px;}
    .score {display: flex; align-items: center; gap: 10px; font-size: 13px; color: #334155;}
    .bar {flex: 1; height: 10px; background: #e2e8f0; border-radius: 9999px; overflow: hidden;}
    .bar > i {display: block; height: 100%; background: #6366f1;}
    .score b {width: 92px; display: inline-block; color: #0f172a;}
    .score em {width: 36px; text-align: right; color: #475569; font-style: normal;}
    .tags {display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;}
    .tag {background: #eef2ff; color: #3730a3; padding: 4px 10px; border-radius: 9999px; font-size: 12px;}

    /* 列印樣式 */
    @media print {
        @page { margin: 14mm; }
        .no-print { display:none !important; }
        body { background:#fff !important; }
        .print-card { box-shadow:none !important; border:1px solid #e5e7eb; }
        
        /* 列印時的並排佈局 */
        .print-flex-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-top: 15px; 
            align-items: flex-start; /* 頂部對齊 */
        }
        .print-scores-section { 
            flex: 1; 
            min-width: 280px; 
            max-width: 45%; /* 調整寬度比例 */
        } 
        .print-chart-section { 
            flex: 1; 
            min-width: 280px; 
            max-width: 50%; /* 調整寬度比例 */
            display: flex; 
            justify-content: center; 
            align-items: center; 
        } 
        .print-chart-section img { max-width: 100%; height: auto; }
        .print-scores-section h3 { margin-top: 0; } 
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6 space-y-5">
    <header class="no-print">
      <h1 class="text-2xl font-bold">仙人指路神獸七十二型人格｜一鍵分析</h1>
      <p class="text-slate-500 text-sm">選擇分析模式、對象與情境 → 按「一鍵分析」。支援分數條、雷達圖、列印 / 匯出 PDF。</p>
    </header>

    <div class="no-print">
        <div class="flex gap-4 mb-4">
            <button id="modePersonality" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">個性分析</button>
            <button id="modeSingle" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">單人分析</button>
            <button id="modeDual" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">雙人分析</button>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
            <!-- 我方 -->
            <section class="bg-white p-4 rounded-2xl shadow-sm">
                <h2 class="font-semibold mb-3">我方 <span id="labelA" class="text-sm text-slate-500">(分析主體)</span></h2>
                <select id="aBeast" class="w-full mb-2 border rounded-lg p-2">
                    <option value="">六獸</option>
                    <option>青龍</option><option>朱雀</option><option>勾陳</option>
                    <option>螣蛇</option><option>白虎</option><option>玄武</option>
                </select>
                <select id="aKin" class="w-full mb-2 border rounded-lg p-2">
                    <option value="">六親</option>
                    <option>父母</option><option>兄弟</option><option>子孫</option>
                    <option>妻財</option><option>官鬼</option>
                </select>
                <select id="aBranch" class="w-full border rounded-lg p-2">
                    <option value="">地支</option>
                    <option>子</option><option>丑</option><option>寅</option><option>卯</option>
                    <option>辰</option><option>巳</option><option>午</option><option>未</option>
                    <option>申</option><option>酉</option><option>戌</option><option>亥</option>
                </select>
            </section>

            <!-- 對方 -->
            <section id="sectionB" class="bg-white p-4 rounded-2xl shadow-sm">
                <h2 class="font-semibold mb-3">對方</h2>
                <select id="bBeast" class="w-full mb-2 border rounded-lg p-2">
                    <option value="">六獸</option>
                    <option>青龍</option><option>朱雀</option><option>勾陳</option>
                    <option>螣蛇</option><option>白虎</option><option>玄武</option>
                </select>
                <select id="bKin" class="w-full mb-2 border rounded-lg p-2">
                    <option value="">六親</option>
                    <option>父母</option><option>兄弟</option><option>子孫</option>
                    <option>妻財</option><option>官鬼</option>
                </select>
                <select id="bBranch" class="w-full border rounded-lg p-2">
                    <option value="">地支</option>
                    <option>子</option><option>丑</option><option>寅</option><option>卯</option>
                    <option>辰</option><option>巳</option><option>午</option><option>未</option>
                    <option>申</option><option>酉</option><option>戌</option><option>亥</option>
                </select>
            </section>
        </div>
    </div>

    <!-- 情境 preset + 自由輸入 -->
    <section id="contextSection" class="bg-white p-4 rounded-2xl shadow-sm space-y-2 no-print">
      <h2 class="font-semibold">情境</h2>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">年度目標協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">績效回饋會議</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">跨部門協作</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">壓期交付專案</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">人際關係協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">愛情</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">性愛</button>
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="輸入情境…" />
      <!-- 性愛深入分析選項 -->
      <div id="sexOptions" class="hidden mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
        <p class="font-semibold text-red-700 mb-2">性愛情境深入分析：</p>
        <div class="flex flex-wrap gap-2">
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="情境描述">情境描述</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="姿勢建議">姿勢建議</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="對話引導">對話引導</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="感官探索">感官探索</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="角色扮演">角色扮演</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="深度連結">深度連結</button>
        </div>
        <textarea id="sexDetailInput" class="w-full mt-2 border rounded-lg p-2 text-sm" placeholder="輸入您想深入分析的細節，例如：『在海邊的夜晚』、『刺激的體位』、『挑逗的對話』…您也可以點選上方預設按鈕，我們會將關鍵詞加入到此處。"></textarea>
      </div>
    </section>

    <!-- 動作列 -->
    <div class="flex flex-wrap items-center gap-3 no-print">
      <button id="go" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">一鍵分析</button>
      <button id="print" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">列印 / 匯出 PDF</button>
      <span id="status" class="text-sm text-slate-600"></span>
    </div>

    <!-- 結果區 -->
    <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
      <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3">
        <span class="px-3 py-1 bg-slate-100 rounded-full">模式：<strong id="chipMode">—</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">我方：<strong id="chipA">—</strong></span>
        <span id="chipB_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">對方：<strong id="chipB">—</strong></span>
        <span id="chipC_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">情境：<strong id="chipC">—</strong></span>
        <span id="chipSexDetail_wrapper" class="px-3 py-1 bg-slate-100 rounded-full hidden">深入：<strong id="chipSexDetail">—</strong></span>
      </div>
      <div id="result" class="prose max-w-none text-[15px]"></div>
      <div id="chartContainer" class="mt-4">
        <!-- 分數條和雷達圖將在這裡顯示 -->
      </div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let analysisMode = 'dual'; // 'personality', 'single', 'dual'
    let radarChart = null; // 儲存 Chart 實例

    // 生成六維度分數條的 HTML
    function generateScoresHTML(scores) {
        if (!scores || Object.values(scores).every(v => v === null || isNaN(v))) {
            return '';
        }
        
        // 確保分數數據正確對應到標籤
        const scoreData = {
            fit: scores.fit || scores['契合'] || 0,
            comm: scores.comm || scores['溝通'] || 0,
            pace: scores.pace || scores['節奏'] || 0,
            account: scores.account || scores['權責'] || 0,
            trust: scores.trust || scores['信任'] || 0,
            innov: scores.innov || scores['創新'] || 0,
        };

        // 修正: 條狀圖的寬度應該是分數值，並確保在 0-100 之間
        const clamp = v => Math.max(0, Math.min(100, Number(v) || 0)); 
        const row = (label, key, color) => `<div class=\"score\"><b>${label}<\/b><div class=\"bar\"><i style=\"width:${clamp(scoreData[key])}%;background:${color}\"><\/i><\/div><em>${clamp(scoreData[key])}<\/em><\/div>`;
        return `
          <h3 class=\"text-lg font-semibold mt-4\">六維度分數<\/h3>
          <div class=\"scores\">
            ${row('契合 fit','fit','#22c55e')}
            ${row('溝通 comm','comm','#06b6d4')}
            ${row('節奏 pace','pace','#f59e0b')}
            ${row('權責 account','account','#8b5cf6')}
            ${row('信任 trust','trust','#ef4444')}
            ${row('創新 innov','innov','#6366f1')}
          <\/div>`;
    }

    // 初始化分析模式
    function setAnalysisMode(mode) {
      analysisMode = mode;
      // 重置所有按鈕樣式
      $$('#modePersonality, #modeSingle, #modeDual').forEach(btn => {
          btn.classList.replace('bg-indigo-600', 'bg-slate-200');
          btn.classList.replace('text-white', 'text-slate-800');
      });
      // 設置當前模式按鈕樣式
      $(`#mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.replace('bg-slate-200', 'bg-indigo-600');
      $(`#mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.replace('text-slate-800', 'text-white');


      if (mode === 'personality') {
        $('#sectionB').style.display = 'none';
        $('#contextSection').style.display = 'none'; // 個性分析不需情境
        $('#labelA').textContent = '(分析對象)';
        // 清空對方欄位
        $('#bBeast').value = ''; $('#bKin').value = ''; $('#bBranch').value = '';
        $('#chipB_wrapper').style.display = 'none';
        $('#context').value = ''; // 清空情境
        $('#chipC_wrapper').style.display = 'none'; // 隱藏情境 chip
        toggleSexOptions(); // 確保性愛選項隱藏
      } else if (mode === 'single') {
        $('#sectionB').style.display = 'none';
        $('#contextSection').style.display = 'block';
        $('#labelA').textContent = '(分析主體)';
        // 清空對方欄位
        $('#bBeast').value = ''; $('#bKin').value = ''; $('#bBranch').value = '';
        $('#chipB_wrapper').style.display = 'none';
        $('#chipC_wrapper').style.display = 'block'; // 顯示情境 chip
      } else { // dual
        $('#sectionB').style.display = 'block';
        $('#contextSection').style.display = 'block';
        $('#labelA').textContent = '';
        $('#chipB_wrapper').style.display = 'block';
        $('#chipC_wrapper').style.display = 'block'; // 顯示情境 chip
      }
      updateChips(getSelections()); // 更新 chips 顯示
    }

    // 預設情境按鈕
    $$('.preset').forEach(b => b.onclick = () => {
        $('#context').value = b.textContent;
        toggleSexOptions(); // 檢查是否需要顯示性愛深入分析選項
        updateChips(getSelections()); // 更新情境 chip
    });

    // 監聽情境輸入框變化，顯示/隱藏性愛深入分析選項
    $('#context').oninput = () => {
        toggleSexOptions();
        updateChips(getSelections()); // 更新情境 chip
    };

    // 性愛深入分析按鈕
    $$('.sex-detail').forEach(b => b.onclick = () => {
        const currentText = $('#sexDetailInput').value.trim();
        const detailType = b.dataset.detail;
        if (!currentText.includes(detailType)) { // 避免重複添加
            $('#sexDetailInput').value = (currentText ? currentText + '；' : '') + detailType;
        }
        updateChips(getSelections()); // 更新深入分析 chip
    });

    // 監聽性愛深入分析輸入框變化
    $('#sexDetailInput').oninput = () => {
        updateChips(getSelections()); // 更新深入分析 chip
    };

    function toggleSexOptions() {
        if ($('#context').value.trim() === '性愛') {
            $('#sexOptions').classList.remove('hidden');
        } else {
            $('#sexOptions').classList.add('hidden');
            $('#sexDetailInput').value = ''; // 清空深入分析內容
        }
    }

    function getSelections(){
      return {
        mode: analysisMode,
        aBeast: $('#aBeast').value, aKin: $('#aKin').value, aBranch: $('#aBranch').value,
        bBeast: $('#bBeast').value, bKin: $('#bKin').value, bBranch: $('#bBranch').value,
        context: analysisMode === 'personality' ? '' : $('#context').value.trim(), // 個性分析模式下情境為空
        sexDetail: ($('#context').value.trim() === '性愛' && !$('#sexOptions').classList.contains('hidden')) ? $('#sexDetailInput').value.trim() : ''
      };
    }

    function updateChips({mode, aBeast,aKin,aBranch,bBeast,bKin,bBranch,context, sexDetail}){
      $('#chipMode').textContent = {
        'personality': '個性分析',
        'single': '單人分析',
        'dual': '雙人分析'
      }[mode];
      $('#chipA').textContent = [aBeast,aKin,aBranch].filter(Boolean).join(' × ') || '—';

      if (mode === 'dual') {
        $('#chipB').textContent = [bBeast,bKin,bBranch].filter(Boolean).join(' × ') || '—';
        $('#chipB_wrapper').style.display = 'block';
      } else {
        $('#chipB_wrapper').style.display = 'none';
      }

      if (mode !== 'personality') {
          $('#chipC').textContent = context || '—';
          $('#chipC_wrapper').style.display = 'block';
      } else {
          $('#chipC_wrapper').style.display = 'none';
      }

      if (context === '性愛' && sexDetail) {
          $('#chipSexDetail').textContent = sexDetail;
          $('#chipSexDetail_wrapper').classList.remove('hidden');
      } else {
          $('#chipSexDetail_wrapper').classList.add('hidden');
      }
    }

    // 文字→HTML排版＋JSON解析
    function formatOutputWithJson(text){
      if(!text) return { html: '', scores: null, tags: [] };

      const jsonBlock = text.match(/```json([\s\S]*?)```/i);
      let json = null;
      if(jsonBlock){
        try{ json = JSON.parse(jsonBlock[1]); }catch(_){ json = null; }
        text = text.replace(jsonBlock[0], '').trim();
      }

      let scores = null;
      if (json && json.scores) {
          scores = json.scores;
      } else {
          const map = { fit:null, comm:null, pace:null, account:null, trust:null, innov:null };
          // 修正正則表達式，支持中文標籤和英文標籤，並捕獲數值
          const rx = /(?:契合|fit)\s*[:：]?\s*(\d{1,3})|(?:溝通|comm)\s*[:：]?\s*(\d{1,3})|(?:節奏|pace)\s*[:：]?\s*(\d{1,3})|(?:權責|account)\s*[:：]?\s*(\d{1,3})|(?:信任|trust)\s*[:：]?\s*(\d{1,3})|(?:創新|innov)\s*[:：]?\s*(\d{1,3})/ig;
          let m; 
          while((m = rx.exec(text))){ 
              if (m[1]) map['fit'] = Number(m[1]);
              if (m[2]) map['comm'] = Number(m[2]);
              if (m[3]) map['pace'] = Number(m[3]);
              if (m[4]) map['account'] = Number(m[4]);
              if (m[5]) map['trust'] = Number(m[5]);
              if (m[6]) map['innov'] = Number(m[6]);
          }
          const filled = Object.values(map).filter(v=>typeof v==='number' && !isNaN(v));
          if(filled.length>=2) scores = map;
      }

      let html = text
        .replace(/\n\s*\n/g, '\n') // 將多個空行替換為單個空行
        .replace(/^\s*(?:[\d]+\)|[•\-–])\s*(.+)$/gm, '<h3 class="text-lg font-semibold mt-4">$1<\/h3>') // 項目編號或列表符號開頭的作為 H3
        .replace(/^\s*[-•–]\s*(.+)$/gm, '<li>$1<\/li>'); // 列表符號
      html = html.replace(/(?:<li>[^<]*<\/li>\n?)+/g, m => `<ul class="list-disc pl-5 space-y-1">${m}<\/ul>`);
      html = html.replace(/\n/g, '<br>'); // 將剩餘的換行符轉換為 <br>
      
      const tagsHTML = json && Array.isArray(json.tags) && json.tags.length ? `<div class=\"tags\">${json.tags.map(t=>`<span class=\\\"tag\\\">${t}<\/span>`).join('')}<\/div>` : '';
      
      return { html, scores, tagsHTML };
    }

    // Radar 圖
    function renderRadar(scores){
      const chartContainer = document.getElementById('chartContainer');
      chartContainer.innerHTML = ''; // 清空容器
      
      // 判斷是否有分數來決定是否渲染雷達圖
      const hasValidScores = scores && Object.values(scores).some(v => v !== null && !isNaN(v));

      let contentHTML = '';
      if (hasValidScores) {
          const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
          const labels = ['契合 fit','溝通 comm','節奏 pace','權責 account','信任 trust','創新 innov'];
          const data = [clamp(scores.fit),clamp(scores.comm),clamp(scores.pace),clamp(scores.account),clamp(scores.trust),clamp(scores.innov)];
          
          // 如果有有效分數，並排放置分數條和雷達圖
          contentHTML = `
            <div class="md:flex md:gap-8 md:items-start">
              <div class="flex-1">${generateScoresHTML(scores)}</div>
              <div class="flex-1 w-full h-64 md:h-80"><canvas id="radar"></canvas></div>
            </div>`;
          chartContainer.innerHTML = contentHTML;

          const canvas = $('#radar');
          if(radarChart){ radarChart.destroy(); } // 銷毀舊圖表
          radarChart = new Chart(canvas.getContext('2d'), {
            type: 'radar', data: { labels, datasets: [{ label: '六維度雷達圖', data, fill: true, backgroundColor: 'rgba(99,102,241,0.15)', borderColor: 'rgba(99,102,241,1)', pointBackgroundColor: 'rgba(99,102,241,1)'}] },
            options: { scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { stepSize: 20 } } }, plugins: { legend: { display: false } } }
          });
      } else {
          // 如果沒有有效分數，只顯示分數條 (如果有的話)
          chartContainer.innerHTML = generateScoresHTML(scores);
          if(radarChart){ radarChart.destroy(); radarChart = null;} // 銷毀舊圖表
      }
    }


    // 一鍵分析
    async function performAnalysis() {
      const payload = getSelections();
      updateChips(payload);

      let isValid = false;

      if (payload.mode === 'personality') {
          isValid = (payload.aBeast && payload.aKin && payload.aBranch);
          if (!isValid) { alert('個性分析：請先選滿我方「六獸、六親、地支」'); return; }
      } else if (payload.mode === 'single') {
        isValid = (payload.aBeast && payload.aKin && payload.aBranch && payload.context);
        if (!isValid) { alert('單人分析：請先選滿我方「六獸、六親、地支」與情境'); return; }
      } else { // dual
        isValid = (payload.aBeast && payload.aKin && payload.aBranch && payload.bBeast && payload.bKin && payload.bBranch && payload.context);
        if (!isValid) { alert('雙人分析：請先選滿我方/對方「六獸、六親、地支」與情境'); return; }
      }

      $('#status').textContent = '分析中…'; $('#result').innerHTML = ''; $('#chartContainer').innerHTML = ''; // 清空圖表容器
      try {
        const res = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`API Request Failed: ${res.status} ${res.statusText} - ${errorText}`);
        }

        const data = await res.json();
        // --- 核心修改點在這裡 ---
        const plain = data.text || "未能獲取分析結果。"; // 現在它會正確地讀取 'text' 鍵的值
        // --- 核心修改點結束 ---

        const formatted = formatOutputWithJson(plain);
        $('#result').innerHTML = formatted.html + formatted.tagsHTML;
        renderRadar(formatted.scores);
        $('#status').textContent = '✅ 完成';
      } catch (e) {
          $('#status').textContent = `❌ 失敗: ${e.message || e}`;
          $('#result').textContent = `分析時發生錯誤，請檢查主控台訊息。錯誤詳情：${e.message || e}`;
          console.error("Analysis failed:", e);
      }
    }

    // 列印 / 匯出 PDF（附上雷達圖快照）
    $('#print').onclick = () => {
      const sel = getSelections(); updateChips(sel);
      
      let chartImg = '';
      // 檢查 radarChart 是否存在且有數據
      const hasValidScores = radarChart && radarChart.data && radarChart.data.datasets[0] && 
                             Object.values(radarChart.data.datasets[0].data).some(v => v !== null && !isNaN(v));

      if (hasValidScores && radarChart.canvas) {
          try {
              // 為了在列印時正確顯示，我們需要一個暫時的 canvas 來確保背景是白色
              const tempCanvas = document.createElement('canvas');
              tempCanvas.width = radarChart.canvas.width;
              tempCanvas.height = radarChart.canvas.height;
              const tempCtx = tempCanvas.getContext('2d');
              tempCtx.fillStyle = 'white'; // 設置背景
              tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); // 填充背景
              tempCtx.drawImage(radarChart.canvas, 0, 0); // 繪製雷達圖
              chartImg = `<div class="print-chart-section"><img src="${tempCanvas.toDataURL('image/png')}" style="max-width: 100%; height: auto;" alt="雷達圖"></div>`;
          } catch (e) {
              console.error("無法生成雷達圖圖片:", e);
              // 如果生成圖片失敗，則不顯示圖片
              chartImg = '';
          }
      }

      const originalBody = document.body.innerHTML; // 備份原始 body 內容
      const originalBodyClass = document.body.className; // 備份原始 body class

      // 準備列印內容
      let printContent = `
        <div class="max-w-5xl mx-auto p-6 space-y-5">
          <header>
            <h1 class="text-2xl font-bold">仙人指路神獸七十二型人格｜分析報告</h1>
            <p class="text-slate-500 text-sm">${new Date().toLocaleString()}</p>
          </header>
          <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
            <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3">
              <span class="px-3 py-1 bg-slate-100 rounded-full">模式：<strong>${$('#chipMode').textContent}</strong></span>
              <span class="px-3 py-1 bg-slate-100 rounded-full">我方：<strong>${$('#chipA').textContent}</strong></span>
              ${sel.mode === 'dual' ? `<span class="px-3 py-1 bg-slate-100 rounded-full">對方：<strong>${$('#chipB').textContent}</strong></span>` : ''}
              ${sel.mode !== 'personality' ? `<span class="px-3 py-1 bg-slate-100 rounded-full">情境：<strong>${$('#chipC').textContent}</strong></span>` : ''}
              ${(sel.context === '性愛' && sel.sexDetail) ? `<span class="px-3 py-1 bg-slate-100 rounded-full">深入：<strong>${$('#chipSexDetail').textContent}</strong></span>` : ''}
            </div>
            <div class="prose max-w-none text-[15px]">
              ${$('#result').innerHTML}
            </div>
            <div class="print-flex-container">
              <div class="print-scores-section">
                ${generateScoresHTML(radarChart && radarChart.data.datasets.length > 0 ? radarChart.data.datasets[0].data.reduce((acc, val, i) => {
                    const labelKey = radarChart.data.labels[i].split(' ')[0].toLowerCase(); // 取英文key
                    acc[labelKey] = val; 
                    return acc;
                }, {}) : null)}
              </div>
              ${chartImg}
            </div>
          </section>
        </div>
      `;

      // 替換 body
      <!-- 替換 body -->
      document.body.innerHTML = printContent;
      document.body.classList.remove('bg-slate-50', 'text-slate-800'); // 移除 body 背景色和文字色，確保列印背景為白色
      document.body.classList.add('bg-white', 'text-black'); // 設置為白色背景黑色文字以供列印

      window.print();

      // 列印完成後恢復原始 body 內容
      // 由於innerHTML被覆蓋，需要重新綁定JS事件和Chart
      // 儲存當前分析模式和結果，以便恢復
      const currentAnalysisMode = analysisMode;
      const currentResultHtml = $('#result').innerHTML;
      const currentChartData = radarChart ? radarChart.data : null;

      document.body.innerHTML = originalBody;
      document.body.className = originalBodyClass; // 恢復原始 class
      
      attachEventListeners(); // 重新綁定所有事件
      setAnalysisMode(currentAnalysisMode); // 恢復模式選擇
      updateChips(getSelections()); // 恢復chips顯示

      // 恢復結果區的內容
      $('#result').innerHTML = currentResultHtml;

      // 重新渲染雷達圖，需要從保存的數據中恢復
      if (currentChartData) {
          const scoresToRestore = currentChartData.datasets[0].data.reduce((acc, val, i) => {
              const labelKey = currentChartData.labels[i].split(' ')[0].toLowerCase();
              acc[labelKey] = val; 
              return acc;
          }, {});
          renderRadar(scoresToRestore);
      } else {
          // 如果沒有雷達圖數據，確保 chartContainer 是空的
          $('#chartContainer').innerHTML = generateScoresHTML(null); 
          if(radarChart){ radarChart.destroy(); radarChart = null;}
      }
    };

    function attachEventListeners() {
        // 解綁所有事件，避免重複綁定 (特別是對於 select 和 input 元素，需要額外處理)
        // 簡單粗暴的方式是替換 innerHTML，但對於 select 的 change 事件等，重新綁定更穩健
        
        $('#modePersonality').onclick = () => setAnalysisMode('personality');
        $('#modeSingle').onclick = () => setAnalysisMode('single');
        $('#modeDual').onclick = () => setAnalysisMode('dual');

        $$('.preset').forEach(b => b.onclick = () => {
            $('#context').value = b.textContent;
            toggleSexOptions(); 
            updateChips(getSelections());
        });

        $('#context').oninput = () => {
            toggleSexOptions();
            updateChips(getSelections());
        };

        $$('.sex-detail').forEach(b => b.onclick = () => {
            const currentText = $('#sexDetailInput').value.trim();
            const detailType = b.dataset.detail;
            if (!currentText.includes(detailType)) {
                $('#sexDetailInput').value = (currentText ? currentText + '；' : '') + detailType;
            }
            updateChips(getSelections());
        });

        $('#sexDetailInput').oninput = () => {
            updateChips(getSelections());
        };

        // 重新綁定 go 按鈕事件
        $('#go').onclick = performAnalysis; // 綁定到獨立的 performAnalysis 函數

        // 重新綁定 select 元素的 change 事件
        $$('select').forEach(select => {
            select.onchange = () => updateChips(getSelections());
        });
    }

    // 頁面加載時初始化
    document.addEventListener('DOMContentLoaded', () => {
        setAnalysisMode('dual'); // 預設為雙人分析
        attachEventListeners(); // 綁定所有事件
        updateChips(getSelections()); // 初始載入時更新一次 chips
    });

  </script>
</body>
</html>
